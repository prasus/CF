---
#Install Riak

- debug: var=ec2_private_ip_address
  tags:
    - riak_install
    - riak_install_onprem

- name: Check Riak Config Exists
  stat: path=/etc/riak/riak.conf
  register: check_riak_exists
  tags:
    - riak_install
    - riak_install_onprem

- name: Backup Riak Config
  copy: src=/etc/riak/riak.conf dest=/tmp/riak.conf
  when: check_riak_exists.stat.exists
  tags:
    - riak_install
    - riak_install_onprem

- name: Get Riak 
  get_url: url={{riak_rpm_url}} dest=/tmp/{{riak_rpm}}
  sudo: yes
  tags:
    - riak_install
    - riak_install_onprem

- name: Install Riak from RPM
  yum: name=/tmp/{{riak_rpm}} state=present
  sudo: yes
  tags:
    - riak_install
    - riak_install_onprem

- name: Copy Riak Conf
  template: src={{ item.src }} dest=/etc/riak/{{ item.dest }} backup=yes
  sudo: yes
  with_items:
    - { src: riak.conf.j2, dest: riak.conf.template }
    - { src: riak.conf.j2, dest: riak.conf }
  tags:
    - riak_install
    - riak_install_onprem

- name: Restore Riak Config
  copy: src=/tmp/riak.conf dest=/etc/riak/riak.conf
  sudo: yes
  when: check_riak_exists.stat.exists
  tags:
    - riak_install
    - riak_install_onprem

- name: Startup Scripts For riak
  template: src={{rc_local_template}} dest={{item}} backup=yes
  with_items:
  - /etc/rc.d/rc.local
  - /etc/rc.local
  sudo: yes
  tags:
    - riak_install
    - riak_install_onprem

- name: Update Startup Scripts For riak
  shell: bash -lc "chmod +x {{item}}"
  with_items:
  - /etc/rc.d/rc.local
  - /etc/rc.local
  sudo: yes
  notify: enable riak
  tags:
    - riak_install
    - riak_install_onprem

- name: Pip Install
  yum: name=python-pip
  sudo: yes
  tags:
    - riak_install_onprem

- name: Install Riak Client Deps
  yum: name="{{item}}" state=present
  with_items:
    - python-devel
    - libffi-devel
    - openssl-devel
    - '@Development tools'
  sudo: yes
  tags:
    - riak_install_onprem

- name : Pip Install riak
  pip: name="{{item}}" state=latest
  with_items:
    - riak
    - requests
  sudo: yes
  tags:
    - riak_install_onprem

- name: Get Riak Rekon
  shell: wget https://github.com/basho/rekon/archive/master.zip
       chdir=/tmp/
  tags:
    - riak_rekon_install

- name: Install Riak Rekon
  shell: unzip master.zip && /tmp/rekon-master/install.sh && rm -rf rekon-master master.zip
       chdir=/tmp/
  register: data
  tags:
    - riak_rekon_install

- debug: var=data.stdout_lines
  tags:
    - riak_rekon_install
