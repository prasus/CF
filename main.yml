---
# Common things that need to be deployed across all instances

- name: Set UNIQUE Id
  set_fact:
     UNIQUE_ID: "UNIQUEID"
  tags:
    - shared_onprem_tasks

- name: Ansible Log Permissions
  file: path=/var/log/ansible.log mode=766 state=touch owner=vera group=vera
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Vera Appliance Log Permissions
  file: path=/home/vera/.vera-appliance.out mode=766 state=touch owner=vera group=vera
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Check for Legacy Update File
  stat: path=/home/vera/.vera-change-ip-done
  register: is_legacy
  tags:
    - shared_onprem_tasks

- name: Set UNIQUE Key
  set_fact:
     UNIQUE_KEY: "UNIQUEKEY"
  tags:
    - shared_onprem_tasks

- name: Set VERA_ENV Var
  shell: echo "export VERA_ENV={{ onprem_env }}" > vera_env.sh
  args:
    chdir: /etc/profile.d/
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Update Startup
  copy: src=bashrc dest=/home/vera/bashrc.template mode=644
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Copy vconfig script
  copy: src=vconfig.sh dest=/usr/bin/vconfig mode=554
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Creates ansible playbooks directory
  file: path=/etc/ansible/playbooks state=directory
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Copy IP change playbook
  copy: src=change_ip.yaml dest=/etc/ansible/playbooks/change_ip.yaml mode=644
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Copy HSM Config script
  copy: src=cfgHSM.sh dest=/usr/bin/cfgHSM.sh mode=554
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Copy server start playbook
  copy: src=start_servers.yaml dest=/etc/ansible/playbooks/start_servers.yaml mode=644
  sudo: yes
  tags:
     - shared_onprem_tasks

- name: Check Vera Done File Exist
  stat: path=/home/vera/.vera-config-done
  register: check_done
  tags:
    - shared_onprem_tasks

- name: Reset Vera Config Done if Exists
  file: path=/home/vera/.vera-config-done state=absent
  when:
    - check_done.stat.exists
  tags:
    - shared_onprem_tasks

- name: Disable iptables
  service: name=iptables state=stopped enabled=no
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Mask iptables
  script: /usr/bin/systemctl mask iptables
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Unmask firewalld
  script: /usr/bin/systemctl unmask firewalld
  sudo: yes
  tags:
    - shared_onprem_tasks

- name: Enable Firewalld
  service: name=firewalld state=stopped enabled=no
  sudo: yes
  tags:
    - shared_onprem_tasks

#- name: Set Firewalld Rules
#  firewalld: port={{item}}/tcp permanent=true state=enabled
#  with_items:
#    - 22
#    - 80
#    - 443
#    - 4369
#    - 8093
#    - 8099
#    - 9200
#    - 9300
#  sudo: yes
#  tags:
#    - shared_onprem_tasks
#
#- name: Restart Firewalld
#  script: /usr/bin/systemctl restart firewalld
#  sudo: yes
#  tags:
#    - shared_onprem_tasks

- include: iptables.yml
- include: ssh.yml
- include: grub.yml
- include: ansible.yml

- name: Ping Host
  command: 'ping -c 1 localhost'
  tags:
    - ping
